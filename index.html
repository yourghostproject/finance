<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YGP Finance — Simple</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    /* Inputs bleus lisibles */
    .input-blue{
      background:#1e3a8a; /* blue-800 */
      color:#fff;
      border:1px solid #1e40af; /* blue-900 */
      border-radius:0.75rem;
      padding:0.5rem 0.75rem;
      width:100%;
      font-size:0.9rem;
    }
    .input-blue::placeholder{ color:#bfdbfe; } /* blue-200 */
    .input-blue:focus{ outline:2px solid #60a5fa; } /* blue-400 */
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:0.6rem 0.9rem;border-radius:0.75rem;border:1px solid #334155;background:#f8fafc}
    .btn:hover{background:#f1f5f9}
    .btn-primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .btn-primary:hover{background:#020617}
    .card{background:rgba(255,255,255,.85);border:1px solid #e2e8f0;border-radius:1rem;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .pill-ok{color:#065f46;background:#d1fae5;padding:2px 8px;border-radius:999px;font-size:12px}
    .pill-alert{color:#9f1239;background:#ffe4e6;padding:2px 8px;border-radius:999px;font-size:12px}
    .table{width:100%;font-size:0.9rem}
    .table th{ text-align:left; color:#64748b; font-weight:600; }
    .table td,.table th{ padding:0.5rem 0.75rem; }
    /* petits selects alignés */
    .select-pair{display:flex;gap:8px}
    .select-pair select{min-width:110px}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-50 to-white text-slate-800">
  <div class="max-w-4xl mx-auto px-4 py-8 space-y-6">

    <header class="flex items-center justify-between">
      <h1 class="text-xl font-bold">YGP Finance — version simple</h1>
      <div class="flex gap-2">
        <button id="btnSeed" class="btn">Ajouter revenus d'octobre</button>
        <button id="btnReset" class="btn">Réinitialiser</button>
      </div>
    </header>

    <!-- 1) Réglages essentiels -->
    <section class="card p-4">
      <h2 class="text-base font-semibold mb-3">Réglages</h2>
      <div class="grid sm:grid-cols-2 gap-3">
        <label class="text-sm">Start (AAAA-MM)
          <input id="startMonth" class="input-blue" value="2025-10" />
        </label>
        <label class="text-sm">Mois à prévoir
          <input id="months" type="number" class="input-blue" value="6" />
        </label>
        <label class="text-sm">Épargne de départ (£)
          <input id="starting" type="number" class="input-blue" value="25749" />
        </label>
        <label class="text-sm">Coût de vie mensuel (£)
          <input id="living" type="number" class="input-blue" value="2500" />
        </label>
        <label class="text-sm">Plancher sécurité (£)
          <input id="floor" type="number" class="input-blue" value="20000" />
        </label>
        <label class="text-sm">Tax pot musique (ex: 0.25)
          <input id="taxRate" type="number" step="0.01" class="input-blue" value="0.25" />
        </label>
      </div>
    </section>

    <!-- 2) Saisie ultra simple des revenus -->
    <section class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-base font-semibold">Entrées (revenus)</h2>
        <button id="btnAddRow" class="btn btn-primary">Ajouter une ligne</button>
      </div>
      <div class="overflow-x-auto">
        <table class="table" id="incomeTable">
          <thead>
            <tr>
              <th>Date (mois + année)</th>
              <th>Mois (prévision)</th>
              <th>Type</th>
              <th>Source</th>
              <th>Montant (£)</th>
              <th>Tax pot</th>
              <th>Net</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="incomeBody"></tbody>
        </table>
      </div>
      <p class="text-xs text-slate-500 mt-2">Utilise <b>Type = Music</b> pour appliquer la réserve (tax pot). La colonne <b>Mois</b> sert au regroupement dans la prévision.</p>
    </section>

    <!-- 3) Prévision claire -->
    <section class="card p-4">
      <h2 class="text-base font-semibold mb-3">Prévision (mensuelle)</h2>
      <div class="overflow-x-auto">
        <table class="table" id="forecastTable">
          <thead>
            <tr>
              <th>Mois</th>
              <th>Ouverture</th>
              <th>Entrées (hors musique)</th>
              <th>Musique (net)</th>
              <th>Coût de vie</th>
              <th>Variation</th>
              <th>Clôture</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody id="forecastBody"></tbody>
        </table>
      </div>
    </section>

  </div>

<script>
const STORAGE='ygp_finance_simple_v2';
let state = JSON.parse(localStorage.getItem(STORAGE)||'{}');
if(!state.settings){
  state = {
    settings:{startMonth:'2025-10',months:6,starting:25749,living:2500,floor:20000,taxRate:0.25},
    incomes:[]
  };
}
const el={
  startMonth:document.getElementById('startMonth'),
  months:document.getElementById('months'),
  starting:document.getElementById('starting'),
  living:document.getElementById('living'),
  floor:document.getElementById('floor'),
  taxRate:document.getElementById('taxRate'),
  incomeBody:document.getElementById('incomeBody'),
  forecastBody:document.getElementById('forecastBody'),
  btnAddRow:document.getElementById('btnAddRow'),
  btnSeed:document.getElementById('btnSeed'),
  btnReset:document.getElementById('btnReset')
};
function save(){ localStorage.setItem(STORAGE, JSON.stringify(state)); }
function monthsFrom(start, n){
  const [Y,M]=start.split('-').map(Number);
  const d=new Date(Y,M-1,1);
  const out=[];
  for(let i=0;i<n;i++){ out.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`); d.setMonth(d.getMonth()+1); }
  return out;
}
function renderSettings(){
  const s=state.settings;
  el.startMonth.value=s.startMonth;
  el.months.value=s.months;
  el.starting.value=s.starting;
  el.living.value=s.living;
  el.floor.value=s.floor;
  el.taxRate.value=s.taxRate;
}
function readSettings(){
  const s=state.settings;
  s.startMonth=el.startMonth.value.trim();
  s.months=parseInt(el.months.value||6,10);
  s.starting=parseFloat(el.starting.value||0);
  s.living=parseFloat(el.living.value||0);
  s.floor=parseFloat(el.floor.value||0);
  s.taxRate=parseFloat(el.taxRate.value||0.25);
  save(); render();
}

/* helpers dropdown */
function yearOptions(start=2024,end=2028){
  const a=[]; for(let y=start;y<=end;y++) a.push(`<option value="${y}">${y}</option>`); return a.join('');
}
function monthOptions(){
  const names=['01','02','03','04','05','06','07','08','09','10','11','12'];
  return names.map((m,i)=>`<option value="${m}">${m}</option>`).join('');
}
function makeSelectPair(currentYYYYMM, attrs){
  const [yy,mm] = (currentYYYYMM||'').split('-');
  return `
    <div class="select-pair">
      <select class="input-blue" ${attrs} data-part="year">
        ${yearOptions()}
      </select>
      <select class="input-blue" ${attrs} data-part="month">
        ${monthOptions()}
      </select>
    </div>
  `;
}
function setPairValues(container, yymm){
  const [yy,mm]=(yymm||'').split('-');
  const y=container.querySelector('select[data-part="year"]');
  const m=container.querySelector('select[data-part="month"]');
  if(yy) y.value=yy; if(mm) m.value=mm;
}
function pairToYYYYMM(container){
  const y=container.querySelector('select[data-part="year"]').value;
  const m=container.querySelector('select[data-part="month"]').value;
  return `${y}-${m}`;
}

/* table income */
function addRow(row){
  state.incomes.push(row||{date:'',month:'',type:'Other',source:'',gross:0});
  save(); renderIncome(); renderForecast();
}
function delRow(i){ state.incomes.splice(i,1); save(); render(); }
function renderIncome(){
  el.incomeBody.innerHTML='';
  state.incomes.forEach((r,i)=>{
    const isMusic = r.type==='Music';
    const tax = isMusic ? (Number(r.gross)||0) * state.settings.taxRate : 0;
    const net = (Number(r.gross)||0) - tax;

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>
        ${makeSelectPair(r.date? r.date.slice(0,7):'', `data-i="${i}" data-field="date"`)}
      </td>
      <td>
        ${makeSelectPair(r.month||'', `data-i="${i}" data-field="month"`)}
      </td>
      <td>
        <select class="input-blue" data-i="${i}" data-k="type">
          <option ${r.type==='Music'?'selected':''}>Music</option>
          <option ${r.type==='Salary'?'selected':''}>Salary</option>
          <option ${r.type==='Other'?'selected':''}>Other</option>
        </select>
      </td>
      <td><input class="input-blue" value="${r.source||''}" data-i="${i}" data-k="source" placeholder="Source"></td>
      <td><input class="input-blue" type="number" value="${r.gross||0}" data-i="${i}" data-k="gross" placeholder="0"></td>
      <td>£${tax.toLocaleString()}</td>
      <td>£${net.toLocaleString()}</td>
      <td><button class="btn" data-del="${i}">Suppr</button></td>
    `;
    el.incomeBody.appendChild(tr);

    // set selects current values
    setPairValues(tr.querySelector(`[data-field="date"][data-i="${i}"]`).parentElement, r.date? r.date.slice(0,7):'');
    setPairValues(tr.querySelector(`[data-field="month"][data-i="${i}"]`).parentElement, r.month||'');
  });
}

/* listeners income */
el.incomeBody.addEventListener('change', (e)=>{
  const sel = e.target.closest('select');
  const input = e.target.closest('input');
  const del = e.target.closest('button[data-del]');
  if(del){ delRow(+del.getAttribute('data-del')); return; }

  if(sel && sel.hasAttribute('data-i') && sel.hasAttribute('data-field')){
    const i = +sel.getAttribute('data-i');
    const field = sel.getAttribute('data-field'); // "date" or "month"
    const container = sel.closest('.select-pair').parentElement; // td
    const yymm = pairToYYYYMM(container.querySelector('.select-pair'));
    if(field==='date'){ state.incomes[i].date = `${yymm}-01`; }
    if(field==='month'){ state.incomes[i].month = yymm; }
    save(); render();
    return;
  }
  if(input && input.hasAttribute('data-i')){
    const i = +input.getAttribute('data-i');
    const k = input.getAttribute('data-k');
    let v = input.value;
    if(k==='gross') v = parseFloat(v||0);
    state.incomes[i][k] = v;
    save(); render();
  }
});

/* forecast */
function sum(arr, fn){ return arr.reduce((a,b)=>a+(fn(b)||0),0); }
function renderForecast(){
  const s=state.settings;
  const months=monthsFrom(s.startMonth,s.months);
  let opening=s.starting;
  el.forecastBody.innerHTML='';
  months.forEach(m=>{
    const rows=state.incomes.filter(r=>r.month===m);
    const nonMusic=sum(rows,r=> r.type!=='Music'? +r.gross:0);
    const musicNet=sum(rows,r=> r.type==='Music'? (+r.gross - (+r.gross*s.taxRate)):0 );
    const inflows=nonMusic+musicNet;
    const change=inflows - s.living;
    const closing=opening + change;
    const ok=closing>=s.floor;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${m}</td>
      <td>£${opening.toLocaleString()}</td>
      <td>£${nonMusic.toLocaleString()}</td>
      <td>£${musicNet.toLocaleString()}</td>
      <td>£${s.living.toLocaleString()}</td>
      <td class="${change<0?'text-rose-600':''}">£${change.toLocaleString()}</td>
      <td class="${ok?'':'text-rose-600 font-semibold'}">£${closing.toLocaleString()}</td>
      <td><span class="${ok?'pill-ok':'pill-alert'}">${ok?'OK':'< £20k'}</span></td>
    `;
    el.forecastBody.appendChild(tr);
    opening=closing;
  });
}
function render(){ renderSettings(); renderIncome(); renderForecast(); }

/* Buttons */
el.btnAddRow.addEventListener('click',()=> addRow());
el.btnSeed.addEventListener('click',()=>{
  addRow({date:'2025-10-01',month:'2025-10',type:'Other',source:'Flat deposit refund',gross:1000});
  addRow({date:'2025-10-01',month:'2025-10',type:'Salary',source:'Final PAYE salary',gross:3300});
});
el.btnReset.addEventListener('click',()=>{
  if(confirm('Tout réinitialiser ?')){
    state={settings:{startMonth:'2025-10',months:6,starting:25749,living:2500,floor:20000,taxRate:0.25}, incomes:[]};
    save(); render();
  }
});

/* settings change */
['startMonth','months','starting','living','floor','taxRate'].forEach(id=>{
  document.getElementById(id).addEventListener('change', readSettings);
});

render();
</script>
</body>
</html>
